<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Data Processing Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #F0F2F5;
            height: 100vh;
            overflow: hidden;
        }
        .desktop-frame {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
            background: white;
        }
        
        /* Skip to main content link for screen readers */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #3498DB;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 100;
            border-radius: 0 0 4px 0;
        }
        .skip-link:focus {
            top: 0;
        }
        

        
        .main-container {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Focus indicator styles - CRITICAL for accessibility */
        *:focus {
            outline: 3px solid #3498DB;
            outline-offset: 2px;
        }
        
        /* Exception for buttons that have their own focus styles */
        .btn:focus,
        .tab:focus,
        .project-link:focus {
            outline: 3px solid #2980B9;
            outline-offset: 2px;
        }
        
        .screen {
            display: none;
            padding: 30px 40px;
        }
        .screen.active {
            display: block;
        }
        
        .content-header {
            background: #ECF0F1;
            padding: 20px 40px;
            border-bottom: 2px solid #BDC3C7;
            margin: -30px -40px 30px -40px;
        }
        .content-title {
            font-size: 24px;
            color: #2C3E50;
            font-weight: 600;
        }
        
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #CED4DA;
            border-radius: 4px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary {
            background: #3498DB;
            color: white;
        }
        .btn-primary:hover {
            background: #2980B9;
        }
        .btn-primary:focus {
            background: #2980B9;
        }
        .btn-secondary {
            background: #ECF0F1;
            color: #2C3E50;
        }
        .btn-secondary:hover {
            background: #D5DBDB;
        }
        
        /* Improved contrast for data source labels */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #DEE2E6;
        }
        .data-table th {
            background: #F8F9FA;
            padding: 14px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 2px solid #DEE2E6;
            color: #2C3E50;
        }
        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #DEE2E6;
        }
        
        /* Improved contrast - changed from #7F8C8D to darker color */
        .data-source {
            color: #495057;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            cursor: help;
            position: relative;
            display: inline-block;
        }
        .data-source:hover,
        .data-source:focus {
            color: #2C3E50;
            text-decoration: underline;
        }
        .data-source .tooltip {
            visibility: hidden;
            background-color: #2C3E50;
            color: white;
            text-align: left;
            padding: 8px 12px;
            border-radius: 4px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .data-source .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2C3E50 transparent transparent transparent;
        }
        .data-source:hover .tooltip,
        .data-source:focus .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .project-link {
            color: #2874A6;
            text-decoration: none;
            font-weight: 500;
        }
        .project-link:hover {
            text-decoration: underline;
            color: #1F618D;
        }
        
        /* Improved actions menu button - now a proper button */
        .actions-btn {
            cursor: pointer;
            font-size: 24px;
            position: relative;
            display: inline-block;
            padding: 5px 10px;
            user-select: none;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            color: #2C3E50;
        }
        .actions-btn:hover {
            background: #F8F9FA;
            border-color: #DEE2E6;
        }
        .actions-btn:focus {
            background: #F8F9FA;
            border-color: #3498DB;
        }
        
        .actions-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #DEE2E6;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 100;
            margin-top: 5px;
        }
        .actions-menu[aria-hidden="false"] {
            display: block;
        }
        
        /* Menu items are now proper buttons */
        .menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            cursor: pointer;
            border: none;
            border-bottom: 1px solid #DEE2E6;
            font-size: 13px;
            text-align: left;
            background: white;
            color: #2C3E50;
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        .menu-item:hover,
        .menu-item:focus {
            background: #F8F9FA;
        }
        
        .upload-zone {
            border: 3px dashed #BDC3C7;
            border-radius: 8px;
            padding: 80px;
            text-align: center;
            background: #F8F9FA;
            margin: 30px 0;
        }
        
        .form-panel {
            max-width: 700px;
            margin: 0 auto;
            background: #F8F9FA;
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            padding: 35px;
        }
        .form-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        .step-indicator {
            width: 40px;
            height: 40px;
            background: #3498DB;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 22px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2C3E50;
        }
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #CED4DA;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .checkbox-group {
            max-height: 320px;
            overflow-y: auto;
        }
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #DEE2E6;
            border-radius: 4px;
            cursor: pointer;
        }
        .checkbox-option:hover {
            background: #F8F9FA;
        }
        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #ECF0F1;
            border-top-color: #3498DB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 100px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results-bar {
            padding: 20px;
            background: #F8F9FA;
            border: 1px solid #DEE2E6;
            border-radius: 4px;
            margin-bottom: 25px;
        }
        
        /* Improved tabs with better contrast */
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #DEE2E6;
            margin-bottom: 30px;
            role: tablist;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            font-size: 14px;
            font-weight: 500;
            color: #2C3E50;
        }
        .tab:hover {
            background: #F8F9FA;
        }
        .tab[aria-selected="true"] {
            color: #2874A6;
            border-bottom-color: #3498DB;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content[aria-hidden="false"] {
            display: block;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }
        .chart-container {
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            padding: 20px;
        }
        .chart-container img {
            width: 100%;
        }
        .chart-container h4 {
            margin-bottom: 15px;
            color: #2C3E50;
        }
        .chart-blurb {
            margin-top: 12px;
            padding: 10px;
            background: #F8F9FA;
            border-left: 3px solid #3498DB;
            font-size: 13px;
            color: #495057;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .image-box {
            aspect-ratio: 1;
            background: #ECF0F1;
            border: 2px solid #DEE2E6;
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .image-box:hover,
        .image-box:focus {
            border-color: #3498DB;
        }
        .image-box.selected {
            border-color: #3498DB;
            border-width: 3px;
        }
        
        .trajectory-data {
            background: #F8F9FA;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #DEE2E6;
        }
        .data-label {
            font-weight: 600;
            color: #2C3E50;
        }
        
        .back-arrow {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #2874A6;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 500;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            background: transparent;
            border: 1px solid transparent;
        }
        .back-arrow:hover {
            text-decoration: underline;
            background: #EBF5FB;
        }
        
        /* Dialog styles */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .dialog-overlay[aria-hidden="false"] {
            display: flex;
        }
        .dialog-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .dialog-content h3 {
            margin-bottom: 20px;
            color: #2C3E50;
        }
        
        .radio-option {
            display: block;
            padding: 15px;
            border: 2px solid #DEE2E6;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .radio-option:hover,
        .radio-option:focus-within {
            border-color: #3498DB;
            background: #EBF5FB;
        }
        .radio-option input[type="radio"] {
            margin-right: 10px;
        }
        
        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="desktop-frame">
        <main id="main-content" class="main-container" role="main">
            <!-- HOME -->
            <section id="home" class="screen active" aria-label="Projects Dashboard">
                <div class="content-header">
                    <h1 class="content-title">Projects Dashboard</h1>
                </div>
                <div class="toolbar" role="search">
                    <label for="project-search" class="sr-only">Search projects</label>
                    <input type="text" id="project-search" class="search-input" placeholder="Search projects..." aria-label="Search projects">
                    <button class="btn btn-primary" onclick="navigate('upload')" aria-label="Create new project">+ New Project</button>
                </div>
                <table class="data-table" role="table" aria-label="Projects list">
                    <thead>
                        <tr>
                            <th scope="col">Project Name</th>
                            <th scope="col">Method</th>
                            <th scope="col">Data Source</th>
                            <th scope="col">Date Created</th>
                            <th scope="col" style="text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><a href="#" class="project-link" onclick="navigate('results'); return false;" aria-label="Open Algae Survey project">Algae Survey</a></td>
                            <td>Mobley Rho Method</td>
                            <td>
                                <span class="data-source" tabindex="0" role="button" aria-label="Data source: Algae_Survey, path: /user/Downloads/Algae_Survey/raw_images">
                                    Algae_Survey
                                    <span class="tooltip" role="tooltip">/user/Downloads/Algae_Survey/raw_images</span>
                                </span>
                            </td>
                            <td><time datetime="2025-09-22">09/22/2025</time></td>
                            <td style="text-align: center;">
                                <span style="position: relative; display: inline-block;">
                                    <button class="actions-btn" 
                                            onclick="toggleMenu(event, this)" 
                                            aria-label="Project actions menu"
                                            aria-haspopup="true"
                                            aria-expanded="false">‚ãÆ</button>
                                    <nav class="actions-menu" role="menu" aria-hidden="true" aria-label="Project actions">
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Export functionality')">Export</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Delete functionality')">Delete</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Duplicate functionality')">Duplicate</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); navigate('settings')">Project Settings</button>
                                    </nav>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><a href="#" class="project-link" onclick="navigate('results'); return false;" aria-label="Open Coastal Water Quality project">Coastal Water Quality</a></td>
                            <td>Black Pixel Method</td>
                            <td>
                                <span class="data-source" tabindex="0" role="button" aria-label="Data source: Coastal_Study, path: /user/Documents/Coastal_Study/multispectral_data">
                                    Coastal_Study
                                    <span class="tooltip" role="tooltip">/user/Documents/Coastal_Study/multispectral_data</span>
                                </span>
                            </td>
                            <td><time datetime="2025-09-15">09/15/2025</time></td>
                            <td style="text-align: center;">
                                <span style="position: relative; display: inline-block;">
                                    <button class="actions-btn" 
                                            onclick="toggleMenu(event, this)" 
                                            aria-label="Project actions menu"
                                            aria-haspopup="true"
                                            aria-expanded="false">‚ãÆ</button>
                                    <nav class="actions-menu" role="menu" aria-hidden="true" aria-label="Project actions">
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Export functionality')">Export</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Delete functionality')">Delete</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Duplicate functionality')">Duplicate</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); navigate('settings')">Project Settings</button>
                                    </nav>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><a href="#" class="project-link" onclick="navigate('results'); return false;" aria-label="Open Lake Michigan Study project">Lake Michigan Study</a></td>
                            <td>Hedley Method</td>
                            <td>
                                <span class="data-source" tabindex="0" role="button" aria-label="Data source: Lake_Michigan, path: /user/Downloads/Lake_Michigan/hyperspectral_imgs">
                                    Lake_Michigan
                                    <span class="tooltip" role="tooltip">/user/Downloads/Lake_Michigan/hyperspectral_imgs</span>
                                </span>
                            </td>
                            <td><time datetime="2025-09-08">09/08/2025</time></td>
                            <td style="text-align: center;">
                                <span style="position: relative; display: inline-block;">
                                    <button class="actions-btn" 
                                            onclick="toggleMenu(event, this)" 
                                            aria-label="Project actions menu"
                                            aria-haspopup="true"
                                            aria-expanded="false">‚ãÆ</button>
                                    <nav class="actions-menu" role="menu" aria-hidden="true" aria-label="Project actions">
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Export functionality')">Export</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Delete functionality')">Delete</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Duplicate functionality')">Duplicate</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); navigate('settings')">Project Settings</button>
                                    </nav>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><a href="#" class="project-link" onclick="navigate('results'); return false;" aria-label="Open Reef Monitoring 2025 project">Reef Monitoring 2025</a></td>
                            <td>Mobley Rho Method</td>
                            <td>
                                <span class="data-source" tabindex="0" role="button" aria-label="Data source: Reef_Data, path: /user/Downloads/Reef_Data/rgb_images">
                                    Reef_Data
                                    <span class="tooltip" role="tooltip">/user/Downloads/Reef_Data/rgb_images</span>
                                </span>
                            </td>
                            <td><time datetime="2025-08-30">08/30/2025</time></td>
                            <td style="text-align: center;">
                                <span style="position: relative; display: inline-block;">
                                    <button class="actions-btn" 
                                            onclick="toggleMenu(event, this)" 
                                            aria-label="Project actions menu"
                                            aria-haspopup="true"
                                            aria-expanded="false">‚ãÆ</button>
                                    <nav class="actions-menu" role="menu" aria-hidden="true" aria-label="Project actions">
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Export functionality')">Export</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Delete functionality')">Delete</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Duplicate functionality')">Duplicate</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); navigate('settings')">Project Settings</button>
                                    </nav>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><a href="#" class="project-link" onclick="navigate('results'); return false;" aria-label="Open Turbidity Assessment project">Turbidity Assessment</a></td>
                            <td>Black Pixel Method</td>
                            <td>
                                <span class="data-source" tabindex="0" role="button" aria-label="Data source: Lake_Erie, path: /user/Downloads/Lake_Erie/raw_water_imgs">
                                    Lake_Erie
                                    <span class="tooltip" role="tooltip">/user/Downloads/Lake_Erie/raw_water_imgs</span>
                                </span>
                            </td>
                            <td><time datetime="2025-08-22">08/22/2025</time></td>
                            <td style="text-align: center;">
                                <span style="position: relative; display: inline-block;">
                                    <button class="actions-btn" 
                                            onclick="toggleMenu(event, this)" 
                                            aria-label="Project actions menu"
                                            aria-haspopup="true"
                                            aria-expanded="false">‚ãÆ</button>
                                    <nav class="actions-menu" role="menu" aria-hidden="true" aria-label="Project actions">
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Export functionality')">Export</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Delete functionality')">Delete</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); alert('Duplicate functionality')">Duplicate</button>
                                        <button class="menu-item" role="menuitem" onclick="event.stopPropagation(); navigate('settings')">Project Settings</button>
                                    </nav>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- UPLOAD -->
            <section id="upload" class="screen" aria-label="Upload Data">
                <div class="content-header">
                    <h1 class="content-title">Upload Data</h1>
                </div>
                <div class="upload-zone" role="region" aria-label="File upload area">
                    <div style="font-size: 48px; margin-bottom: 20px;" aria-hidden="true">üìÅ</div>
                    <p>Select your data folder with the standard structure</p>
                    <p style="color: #495057; font-size: 13px; margin-top: 10px;">
                        Required: panel/, raw_sky_imgs/, raw_water_imgs/, align_img/
                    </p>
                    <button id="uploadFolderBtn" class="btn btn-primary" type="button" aria-label="Upload folder">Upload Folder</button>
                </div>
                <nav class="form-actions" aria-label="Upload navigation">
                    <button class="btn btn-secondary" onclick="navigate('home')">Cancel</button>
                    <button class="btn btn-primary" onclick="navigate('method')">Next</button>
                </nav>
            </section>

            <!-- METHOD -->
            <section id="method" class="screen" aria-label="Method Selection">
                <div class="content-header">
                    <h1 class="content-title">Method Selection</h1>
                </div>
                <form class="form-panel" onsubmit="event.preventDefault(); navigate('outputs');">
                    <div class="form-header">
                        <div class="step-indicator" aria-label="Step 1">1</div>
                        <h2 style="font-size: 20px; font-weight: 600;">Select Processing Methods</h2>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="glintSelect">Sky Glint Removal Method</label>
                        <select id="glintSelect" class="form-select" required aria-required="true">
                            <option value="" selected disabled>Select method...</option>
                            <option value="mobley_rho">Mobley Rho Method</option>
                            <option value="black_pixel">Black Pixel Method</option>
                            <option value="hedley">Hedley Method</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="irradianceSelect">Irradiance Normalization Method</label>
                        <select id="irradianceSelect" class="form-select" required aria-required="true">
                            <option value="" selected disabled>Select method...</option>
                            <option value="panel_ed">Panel Ed</option>
                            <option value="dls_ed">DLS Ed</option>
                            <option value="dls_corrected_panel">DLS corrected by panel</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="maskingSelect">Pixel Masking (Optional)</label>
                        <select id="maskingSelect" class="form-select">
                            <option value="">None</option>
                            <option value="value_threshold">Value Threshold</option>
                            <option value="std_threshold">Standard Deviation Threshold</option>
                        </select>
                    </div>

                    <nav class="form-actions" aria-label="Method selection navigation">
                        <button type="button" class="btn btn-secondary" onclick="navigate('upload')">Back</button>
                        <button type="submit" class="btn btn-primary">Next</button>
                    </nav>
                </form>
            </section>

            <!-- OUTPUTS -->
            <section id="outputs" class="screen" aria-label="Output Selection">
                <div class="content-header">
                    <h1 class="content-title">Output Selection</h1>
                </div>
                <form class="form-panel" onsubmit="event.preventDefault(); processData();">
                    <div class="form-header">
                        <div class="step-indicator" aria-label="Step 2">2</div>
                        <h2 style="font-size: 20px; font-weight: 600;">Select Outputs</h2>
                    </div>
                    <fieldset class="checkbox-group">
                        <legend class="sr-only">Select output types</legend>
                        <label class="checkbox-option">
                            <input type="checkbox" class="outputChk" data-key="reflectance" id="output-reflectance">
                            <span>Reflectance spectra</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" class="outputChk" data-key="chla_hu" id="output-chla-hu">
                            <span>Chlorophyll-a (Hu Color Index)</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" class="outputChk" data-key="chla_ocx" id="output-chla-ocx">
                            <span>Chlorophyll-a (OCx Band Ratio)</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" class="outputChk" data-key="chla_blended" id="output-chla-blended">
                            <span>Chlorophyll-a (Blended Hu+OCx)</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" class="outputChk" data-key="chla_gitelson" id="output-chla-gitelson">
                            <span>Chlorophyll-a (Gitelson)</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" class="outputChk" data-key="tsm" id="output-tsm">
                            <span>Total Suspended Matter (TSM)</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" class="outputChk" data-key="mosaics" id="output-mosaics">
                            <span>Mosaics</span>
                        </label>
                    </fieldset>
                    <nav class="form-actions" aria-label="Output selection navigation">
                        <button type="button" class="btn btn-secondary" onclick="navigate('method')">Back</button>
                        <button type="submit" id="processBtn" class="btn btn-primary">Process</button>
                    </nav>
                </form>
            </section>

            <!-- LOADING -->
            <section id="loading" class="screen" aria-label="Processing" aria-live="polite">
                <div class="content-header">
                    <h1 class="content-title">Processing</h1>
                </div>
                <div class="spinner" role="status" aria-label="Loading"></div>
                <p style="text-align: center;">Processing data...</p>
            </section>

            <!-- RESULTS -->
            <section id="results" class="screen" aria-label="Project Results">
                <div class="content-header">
                    <h1 class="content-title">Results</h1>
                </div>

                <a href="#" class="back-arrow" onclick="navigate('home'); return false;">
                    ‚Üê Back to Projects
                </a>

                <div class="results-bar">
                    <h2 style="font-size: 20px; margin-bottom: 8px;">Algae Survey</h2>
                    <p><time datetime="2025-09-22">22.09.2025</time> | Location: 42.0235¬∞N, 83.4075¬∞W</p>
                </div>

                <div class="tabs" role="tablist" aria-label="Results sections">
                    <button class="tab" 
                            role="tab" 
                            aria-selected="true" 
                            aria-controls="overview"
                            id="tab-overview"
                            onclick="switchTab(event, 'overview')">Overview</button>
                    <button class="tab" 
                            role="tab" 
                            aria-selected="false" 
                            aria-controls="images"
                            id="tab-images"
                            onclick="switchTab(event, 'images')">Images</button>
                    <button class="tab" 
                            role="tab" 
                            aria-selected="false" 
                            aria-controls="trajectory"
                            id="tab-trajectory"
                            onclick="switchTab(event, 'trajectory')">Flight Trajectory</button>
                    <button class="tab" 
                            role="tab" 
                            aria-selected="false" 
                            aria-controls="mosaic"
                            id="tab-mosaic"
                            onclick="switchTab(event, 'mosaic')">Mosaic</button>
                </div>

                <div id="overview" class="tab-content" role="tabpanel" aria-labelledby="tab-overview" aria-hidden="false">
                    <div id="overviewCards" class="charts-grid"></div>
                </div>

                <div id="images" class="tab-content" role="tabpanel" aria-labelledby="tab-images" aria-hidden="true">
                    <div class="images-grid" role="list" aria-label="Processed images">
                        <button class="image-box" role="listitem" aria-label="Image 1" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 2" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 3" tabindex="0"></button>
                        <button class="image-box selected" role="listitem" aria-label="Image 4, selected" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 5" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 6" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 7" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 8" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 9" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 10" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 11" tabindex="0"></button>
                        <button class="image-box" role="listitem" aria-label="Image 12" tabindex="0"></button>
                    </div>
                </div>

                <div id="trajectory" class="tab-content" role="tabpanel" aria-labelledby="tab-trajectory" aria-hidden="true">
                    <div class="trajectory-data">
                        <h3 style="margin-bottom: 15px;">Flight Data Summary</h3>
                        <dl>
                            <div class="data-row">
                                <dt class="data-label">Altitude:</dt>
                                <dd>260-268 m</dd>
                            </div>
                            <div class="data-row">
                                <dt class="data-label">Latitude/Longitude:</dt>
                                <dd>42.0235¬∞N, 83.4075¬∞W</dd>
                            </div>
                            <div class="data-row">
                                <dt class="data-label">Yaw:</dt>
                                <dd>0-350¬∞</dd>
                            </div>
                        </dl>
                    </div>
                    <img src="https://i.imgur.com/Jy2rdnZ.png" alt="Flight trajectory map showing drone path and data collection points" style="width: 100%; border-radius: 4px;">
                </div>

                <div id="mosaic" class="tab-content" role="tabpanel" aria-labelledby="tab-mosaic" aria-hidden="true">
                    <div style="background: #F8F9FA; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">Map Controls</h3>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" style="padding: 8px 16px;" aria-label="Toggle map layer">üó∫Ô∏è Toggle Map Layer</button>
                            <button class="btn btn-secondary" style="padding: 8px 16px;" aria-label="Zoom">üîç Zoom</button>
                            <button class="btn btn-secondary" style="padding: 8px 16px;" aria-label="Add marker">üìç Add Marker</button>
                            <button class="btn btn-primary" style="padding: 8px 16px;" onclick="toggleMosaicEditMode()" aria-label="Edit mosaic position">‚úèÔ∏è Edit Mosaic Position</button>
                        </div>
                    </div>

                    <div id="mosaicEditControls" style="display: none; background: #FFF3CD; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #FFC107;" role="region" aria-label="Mosaic editing controls">
                        <h3>Edit Mode Active</h3>
                        <p style="margin: 10px 0; font-size: 13px;">Click and drag the mosaic to reposition. Use controls below to rotate.</p>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap;">
                            <label for="rotationValue">Rotation:</label>
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="rotateMosaic(-5)" aria-label="Rotate left 5 degrees">‚Ü∂ -5¬∞</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="rotateMosaic(-1)" aria-label="Rotate left 1 degree">‚Ü∂ -1¬∞</button>
                            <input type="number" 
                                   id="rotationValue" 
                                   value="0" 
                                   aria-label="Rotation in degrees"
                                   style="width: 70px; padding: 6px; text-align: center; border: 1px solid #CED4DA; border-radius: 4px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="rotateMosaic(1)" aria-label="Rotate right 1 degree">‚Ü∑ +1¬∞</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="rotateMosaic(5)" aria-label="Rotate right 5 degrees">‚Ü∑ +5¬∞</button>
                            <button class="btn btn-primary" style="padding: 6px 16px; margin-left: 20px;" onclick="saveMosaicPosition()">Save Position</button>
                            <button class="btn btn-secondary" style="padding: 6px 16px;" onclick="toggleMosaicEditMode()">Cancel</button>
                        </div>
                    </div>

                    <div id="mosaicContainer" style="position: relative; cursor: default;">
                        <img src="https://i.imgur.com/fBJpRAc.jpeg" 
                             alt="Georeferenced mosaic overlay of surveyed area" 
                             id="mosaicImage" 
                             style="width: 100%; transition: transform 0.2s;">
                    </div>

                    <div class="chart-blurb" style="margin-top: 15px;">
                        Final georeferenced mosaic overlay. Coordinates: 42.0235¬∞N, 83.4075¬∞W | Resolution: 2.5 cm/pixel
                    </div>
                </div>
            </section>

            <!-- SETTINGS -->
            <section id="settings" class="screen" aria-label="Project Settings">
                <div class="content-header">
                    <h1 class="content-title">Project Settings</h1>
                </div>
                
                <a href="#" class="back-arrow" onclick="navigate('home'); return false;">
                    ‚Üê Back to Home Page
                </a>

                <div style="margin-bottom: 30px;">
                    <h2 style="font-size: 22px; margin-bottom: 8px;">Algae Survey</h2>
                    <p style="color: #495057;">Data Source: /user/Downloads/Algae_Survey/raw_images | Created: <time datetime="2025-09-22">09/22/2025</time></p>
                </div>

                <form class="form-panel" onsubmit="event.preventDefault(); showProjectOptionsDialog();">
                    <h3 style="margin-bottom: 20px;">Change Project Settings</h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="settings-glint">Sky Glint Removal Method</label>
                        <select id="settings-glint" class="form-select">
                            <option selected>Mobley Rho Method</option>
                            <option>Black Pixel Method</option>
                            <option>Hedley Method</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="settings-irradiance">Irradiance Normalization Method</label>
                        <select id="settings-irradiance" class="form-select">
                            <option selected>Panel Ed</option>
                            <option>DLS Ed</option>
                            <option>DLS corrected by panel</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="settings-masking">Pixel Masking</label>
                        <select id="settings-masking" class="form-select">
                            <option>None</option>
                            <option selected>Value Threshold</option>
                            <option>Standard Deviation Threshold</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Selected Outputs</label>
                        <fieldset class="checkbox-group">
                            <legend class="sr-only">Select output types</legend>
                            <label class="checkbox-option">
                                <input type="checkbox" id="settings-output-reflectance">
                                <span>Reflectance spectra</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="settings-output-chlorophyll-hu">
                                <span>Chlorophyll-a (Hu Color Index)</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="settings-output-chlorophyll-ocx">
                                <span>Chlorophyll-a (OCx Band Ratio)</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="settings-output-chlorophyll-blended">
                                <span>Chlorophyll-a (Blended Hu+OCx)</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="settings-output-chlorophyll-gitelson">
                                <span>Chlorophyll-a (Gitelson)</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="settings-output-tsm">
                                <span>Total Suspended Matter (TSM)</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" id="settings-output-mosaics">
                                <span>Mosaics</span>
                            </label>
                        </fieldset>
                    </div>

                    <nav class="form-actions" aria-label="Settings navigation">
                        <button type="button" class="btn btn-secondary" onclick="navigate('home')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Apply Changes</button>
                    </nav>
                </form>
            </section>
        </main>

        <!-- PROJECT OPTIONS DIALOG -->
        <div id="projectOptionsDialog" 
             class="dialog-overlay" 
             role="dialog" 
             aria-modal="true" 
             aria-labelledby="dialog-title"
             aria-hidden="true">
            <div class="dialog-content">
                <h3 id="dialog-title" style="margin-bottom: 20px; color: #2C3E50;">Apply Settings Changes</h3>
                <p style="margin-bottom: 25px; color: #495057;">How would you like to apply these changes?</p>
                
                <fieldset style="border: none; padding: 0;">
                    <legend class="sr-only">Choose how to apply changes</legend>
                    <label class="radio-option">
                        <input type="radio" name="projectOption" value="update" checked>
                        <div>
                            <strong>Update Existing Project</strong>
                            <div style="font-size: 13px; color: #495057; margin-top: 5px;">Reprocess and overwrite current results</div>
                        </div>
                    </label>
                    
                    <label class="radio-option">
                        <input type="radio" name="projectOption" value="new">
                        <div>
                            <strong>Process as New Project</strong>
                            <div style="font-size: 13px; color: #495057; margin-top: 5px;">Create a copy with a new name</div>
                        </div>
                    </label>
                </fieldset>
                
                <div id="newProjectNameField" style="display: none; margin-bottom: 20px;">
                    <label for="newProjectName" style="display: block; margin-bottom: 8px; font-weight: 500;">New Project Name</label>
                    <input type="text" 
                           id="newProjectName" 
                           placeholder="Enter new project name..." 
                           aria-label="New project name"
                           style="width: 100%; padding: 10px; border: 1px solid #CED4DA; border-radius: 4px;">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button class="btn btn-secondary" onclick="closeProjectOptionsDialog()">Cancel</button>
                    <button class="btn btn-primary" onclick="applyProjectChanges()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function navigate(screen) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
                s.setAttribute('aria-hidden', 'true');
            });
            
            // Show target screen
            const targetScreen = document.getElementById(screen);
            targetScreen.classList.add('active');
            targetScreen.removeAttribute('aria-hidden');
            
            // Focus management
            const heading = targetScreen.querySelector('h1, h2');
            if (heading) {
                heading.setAttribute('tabindex', '-1');
                heading.focus();
            }

            if (screen === 'loading') {
                setTimeout(() => navigate('results'), 2000);
            }
        }

        function processData() {
            navigate('loading');
        }

        function toggleMenu(e, button) {
            e.stopPropagation();
            const menu = button.nextElementSibling;
            const isExpanded = button.getAttribute('aria-expanded') === 'true';
            
            // Close all other menus
            document.querySelectorAll('.actions-btn').forEach(btn => {
                btn.setAttribute('aria-expanded', 'false');
                const otherMenu = btn.nextElementSibling;
                if (otherMenu) {
                    otherMenu.setAttribute('aria-hidden', 'true');
                }
            });
            
            // Toggle current menu
            button.setAttribute('aria-expanded', !isExpanded);
            menu.setAttribute('aria-hidden', isExpanded);
            
            // Focus first menu item when opening
            if (!isExpanded) {
                setTimeout(() => {
                    const firstItem = menu.querySelector('.menu-item');
                    if (firstItem) firstItem.focus();
                }, 0);
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.actions-btn').forEach(btn => {
                btn.setAttribute('aria-expanded', 'false');
                const menu = btn.nextElementSibling;
                if (menu) {
                    menu.setAttribute('aria-hidden', 'true');
                }
            });
        });

        // Keyboard navigation for menus
        document.addEventListener('keydown', function(e) {
            const activeMenu = document.querySelector('.actions-menu[aria-hidden="false"]');
            if (!activeMenu) return;
            
            const items = Array.from(activeMenu.querySelectorAll('.menu-item'));
            const currentIndex = items.indexOf(document.activeElement);
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const nextIndex = (currentIndex + 1) % items.length;
                items[nextIndex].focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                items[prevIndex].focus();
            } else if (e.key === 'Escape') {
                const btn = activeMenu.previousElementSibling;
                btn.setAttribute('aria-expanded', 'false');
                activeMenu.setAttribute('aria-hidden', 'true');
                btn.focus();
            }
        });

        function switchTab(e, tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.setAttribute('aria-selected', 'false');
            });
            
            // Update tab panels
            document.querySelectorAll('.tab-content').forEach(content => {
                content.setAttribute('aria-hidden', 'true');
            });
            
            // Activate selected tab
            if (e && e.currentTarget) {
                e.currentTarget.setAttribute('aria-selected', 'true');
            }
            
            const panel = document.getElementById(tabName);
            panel.setAttribute('aria-hidden', 'false');
        }

        // Dialog functions
        function showProjectOptionsDialog() {
            const dialog = document.getElementById('projectOptionsDialog');
            dialog.setAttribute('aria-hidden', 'false');
            
            // Focus first focusable element
            setTimeout(() => {
                const firstRadio = dialog.querySelector('input[type="radio"]');
                if (firstRadio) firstRadio.focus();
            }, 0);
            
            // Listen for radio changes
            document.querySelectorAll('input[name="projectOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const newNameField = document.getElementById('newProjectNameField');
                    if (this.value === 'new') {
                        newNameField.style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('newProjectName').focus();
                        }, 0);
                    } else {
                        newNameField.style.display = 'none';
                    }
                });
            });
        }

        function closeProjectOptionsDialog() {
            const dialog = document.getElementById('projectOptionsDialog');
            dialog.setAttribute('aria-hidden', 'true');
        }

        function applyProjectChanges() {
            const selectedOption = document.querySelector('input[name="projectOption"]:checked').value;
            
            if (selectedOption === 'new') {
                const newName = document.getElementById('newProjectName').value.trim();
                if (!newName) {
                    alert('Please enter a project name');
                    return;
                }
                console.log('Creating new project:', newName);
            } else {
                console.log('Updating existing project');
            }
            
            closeProjectOptionsDialog();
            navigate('loading');
        }

        // Mosaic editing functions
        let mosaicEditMode = false;
        let currentRotation = 0;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        function toggleMosaicEditMode() {
            mosaicEditMode = !mosaicEditMode;
            const controls = document.getElementById('mosaicEditControls');
            const container = document.getElementById('mosaicContainer');
            
            if (mosaicEditMode) {
                controls.style.display = 'block';
                container.style.cursor = 'grab';
                enableDragging();
            } else {
                controls.style.display = 'none';
                container.style.cursor = 'default';
                disableDragging();
            }
        }

        function enableDragging() {
            const container = document.getElementById('mosaicContainer');
            container.addEventListener('mousedown', startDrag);
            container.addEventListener('mousemove', drag);
            container.addEventListener('mouseup', endDrag);
            container.addEventListener('mouseleave', endDrag);
        }

        function disableDragging() {
            const container = document.getElementById('mosaicContainer');
            container.removeEventListener('mousedown', startDrag);
            container.removeEventListener('mousemove', drag);
            container.removeEventListener('mouseup', endDrag);
            container.removeEventListener('mouseleave', endDrag);
        }

        function startDrag(e) {
            if (!mosaicEditMode) return;
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            document.getElementById('mosaicContainer').style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging || !mosaicEditMode) return;
            e.preventDefault();
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateMosaicTransform();
        }

        function endDrag() {
            isDragging = false;
            if (mosaicEditMode) {
                document.getElementById('mosaicContainer').style.cursor = 'grab';
            }
        }

        function rotateMosaic(degrees) {
            currentRotation += degrees;
            document.getElementById('rotationValue').value = currentRotation;
            updateMosaicTransform();
            
            // Announce to screen readers
            const announcement = `Mosaic rotated to ${currentRotation} degrees`;
            announceToScreenReader(announcement);
        }

        function updateMosaicTransform() {
            const image = document.getElementById('mosaicImage');
            image.style.transform = `translate(${translateX}px, ${translateY}px) rotate(${currentRotation}deg)`;
        }

        function saveMosaicPosition() {
            console.log('Saving mosaic position:', {
                translateX,
                translateY,
                rotation: currentRotation
            });
            alert(`Mosaic position saved!\nX: ${translateX}px, Y: ${translateY}px, Rotation: ${currentRotation}¬∞`);
            toggleMosaicEditMode();
        }

        // Helper function for screen reader announcements
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            setTimeout(() => announcement.remove(), 1000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape key to close dialogs
            if (e.key === 'Escape') {
                const dialog = document.getElementById('projectOptionsDialog');
                if (dialog.getAttribute('aria-hidden') === 'false') {
                    closeProjectOptionsDialog();
                }
            }
        });
    </script>
</body>
</html>